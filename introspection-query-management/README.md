# Introspection Query Management

GraphQL has an [introspection system](https://graphql.org/learn/introspection) that allows users to ask a schema for information about the queries it supports. This can be a useful tool to aid build pipelines and developers working on a GraphQL API.

GraphQL introspection queries are useful, but enabling the system in production environments can expose the API to security risks.

Read more about [why you should disable GraphQL introspection in production](https://www.apollographql.com/blog/graphql/security/why-you-should-disable-graphql-introspection-in-production/).

Brightspot makes it possible to create introspection query rules that allow or block introspection queries based upon any custom logic. This example demonstrates how to use JS classes to create an introspection query rule that only allows a query if the request provides a specific `Introspection-Key` header.

## What you will learn

1. How to create an introspection query rule.
2. How to check the headers of an introspection query request so they can be validated.
3. How to apply an introspection query rule to a Brightspot GraphQL API endpoint.

## Running the example application

Refer to the [README](/README.md) at the root of the `react-examples` repository for details on running example applications in depth. Make sure you have the Docker instance for the example applications running, then follow the quick-start steps starting in the `introspection-query-management` directory:

To upload JS Classes in Brightspot (http://localhost/cms):

```sh
cd brightspot
yarn
npx brightspot types download
npx brightspot types upload src
```

To setup the front end, run the following command from the `introspection-query-management/app` directory:

```sh
yarn
```

## Using the example application

The front end application uses types generated by the [GraphQL Code Generator](https://www.the-guild.dev/graphql/codegen) as part of the build pipeline. GraphQL Code Generator is set up to run introspection queries on the `Introspection Query Management Endpoint` in Brightspot at **Navigation Menu** &rarr; **Admin** &rarr; **APIs** &rarr; **Endpoints** &rarr; **Introspection Query Management**.

Those introspection queries fail if they do not include an `Introspection-Key` header with a value of `correct-value`. To demonstrate this, the front end application is configured to use an incorrect `Introspection-Key` value.

Run the command `yarn codegen` from the `introspection-query-management/app` directory to make the GraphQL Code Generator run the introspection queries. An error message will appear saying the command failed.

Then change the value of `INTROSPECTION-KEY` in the `introspection-query-management/app/.env` file to `correct-value` and run the `yarn codegen` command again. The introspection queries will run and the GraphQL Code Generator will create files that the front end application needs in order to run.

Start the front end application by running the command `yarn start` in the `introspection-query-management/app` directory. The front-end application displays **Song** content created in Brightspot. Publish at least one **Song** and navigate to the front-end application to see the content displayed.

> **_Note_** The front end app's GraphQL API call does not include any API keys or forms of validation because normal queries on the endpoint are completely open to the public.

## How everything works

1. The `ExampleIntrospectionQueryRule` implements the `isAllowed()` method which should return `true` in cases where introspection queries are allowed.

2. The `ExampleIntrospectionQueryRule` checks for an `Introspection-Key` header using the `WebRequest.getCurrent().getHeader()` method and compares its value to the preset `correct-value`.

3. The `ExampleIntrospectionQueryRule` is applied to the `IntrospectionQueryMangagementEndpoint` when the endpoint implements the `getIntrospectionQueryRule()` method.

The end result is a GraphQL API that is open to the public but with introspection queries available only to internal developers. This provides a layer of security by obscurity.

#### Points to note in the JS Class files:

- `WebRequest.getCurrent().getHeader('Introspection-Key')`: Any non-reserved header name can be used. `Introspection-Key` is for demonstration purposes.
- `'correct-value'`: The hard coded introspection key in this example is for demonstration purposes. Brightspot recommends using a unique, random, and non-guessable value in production environments. The value can also be hidden away using environment variables.

#### Points to note in the front end application:

- `codegen.yml`: The headers used in the GraphQL Code Generator can be edited in this file.
- `queries/AllSongs.graphql`: Only the fields listed in this query will be visible in a web browser's development tools. All other fields on the `Song` content type are available but hidden.

## Try it yourself

The following is a suggestion for learning more about GraphQL introspection with JS Classes and Brightspot:

1. Try changing the introspection query rule to support multiple keys.
2. Try making the introspection key configurable in Brightspot. Hint: You will need to add a `JavaField` to the endpoint and the introspection query rule.

## Troubleshooting

Refer to the [Common Issues](/README.md) section in the repository README for assistance.
