# Introspection Query Management

GraphQL has an [introspection system](https://graphql.org/learn/introspection) that allows users to ask a schema for information about the queries it supports. This can be a useful tool to aid build pipelines and developers working on a GraphQL API.

GraphQL introspection queries are useful, but enabling the system in production environments can expose the API to security risks.

Read more about [why you should disable GraphQL introspection in production](https://www.apollographql.com/blog/graphql/security/why-you-should-disable-graphql-introspection-in-production/).

Brightspot makes it possible to create introspection query rules that allow or block introspection queries based upon any custom logic. This example demonstrates how to create an introspection query rule the only allows a query if the request provides a specific `Introspection-Key` header.

## What you will learn

1. How to create an introspection query rule.
2. How to check the headers of an introspection query request so they can be validated.
3. How to apply an introspection query rule to a Brightspot GraphQL API endpoint.

## Running the example application

Refer to the [README](/README.md) at the root of the `react-examples` repository for details on running example applications in depth. Make sure you have the Docker instance for the example applications running, then follow the quick-start steps starting in the `introspection-query-management` directory:

To upload JS Classes in Brightspot (http://localhost/cms):

```sh
cd brightspot
yarn
npx brightspot types download
npx brightspot types upload src
```

To setup the front end, run the following command from the `introspection-query-management/app` directory:

```sh
yarn
```

## Using the example application

The front end application uses types generated by the [GraphQL Code Generator](https://www.the-guild.dev/graphql/codegen) as part of the build pipeline. GraphQL Code Generator is set up to run introspection queries on the `Introspection Query Management Endpoint` in Brightspot at **Navigation Menu** &rarr; **Admin** &rarr; **APIs** &rarr; **Endpoints** &rarr; **Introspection Query Management**.

Those introspection queries fail if they do not include an `Introspection-Key` header with a value of `correct-value`. To demonstrate this, the front end application is configured to use an incorrect `Introspection-Key` value.

Run the command `yarn codegen` from the `introspection-query-management/app` directory to make the GraphQL Code Generator run the introspection queries. An error message will appear saying the command failed.

Then change the value of `INTROSPECTION-KEY` in the `introspection-query-management/app/.env` file to `correct-value` and run the `yarn codegen` command again. The introspection queries will run and the GraphQL Code Generator will create files that the front end application needs in order to run.

Start the front end application by running the command `yarn start` in the `introspection-query-management/app` directory. The front-end application displays **Song** content created in Brightspot. Publish at least one **Song** and navigate to the front-end application to see the content displayed.

> **_Note_** The front end app's GraphQL API call does not include any API keys or forms of validation because normal queries on the endpoint are completely open to the public.

## How everything works

1. The `ExampleIntrospectionQueryRule` class implements the `IntrospectionQueryRule` interface and the `isAllowed()` method which should return `true` in cases where introspection queries are allowed.

```ts
export default class ExampleIntrospectionQueryRule extends JavaClass(
  'brightspot.example.introspection_query_management.ExampleIntrospectionQueryRule',
  Object,
  IntrospectionQueryRule
) {
  [`isAllowed()`](): boolean {
    return false // blocks all introspection queries
  }
}
```

2. The logic in the `isAllowed()` method compares the value of a header in the introspection query's request to that of the value of the introspection key. The header is named `Introspection-Key` (though any non-reserved header name can be used) and can be accessed through the `WebRequest.getCurrent().getHeader()` method. The introspection key in this example is hard-coded to be `correct-value` for demonstration purposes. Brightspot recommends using a unique, random, and non-guessable value in production environments. The value can also be hidden away using environment variables.

```ts
  [`isAllowed()`](): boolean {
    return WebRequest.getCurrent().getHeader('Introspection-Key') === 'correct-value'
  }
```

3. The `ExampleIntrospectionQueryRule` is applied to the `IntrospectionQueryManagementEndpoint` when the endpoint implements the `getIntrospectionQueryRule()` method and returns a new `ExampleIntrospectionQueryRule` object.

```ts
export default class IntrospectionQueryManagementEndpoint extends JavaClass(
  'brightspot.example.introspection_query_management',
  ContentDeliveryApiEndpointV1,
  Singleton
) {
  // ...

  getIntrospectionQueryRule(): IntrospectionQueryRule {
    const ExampleIntrospectionQueryRule = ClassFinder.getClass(
      'brightspot.example.introspection_query_management.ExampleIntrospectionQueryRule'
    )

    return new ExampleIntrospectionQueryRule()
  }
}
```

4. The front end application uses GraphQL Code Generator to create types and hooks. It is configured with the `codegen.yml` file in the `introspection-query-management/app` directory. The name of the introspection key header is defined here and its value is derived from an environment variable in the `.env` file within the same directory.

`codegen.yml` :

```yml
overwrite: true
schema:
  - ${REACT_APP_GRAPHQL_URL}:
      headers:
        Introspection-Key: ${INTROSPECTION_KEY}
documents: './src/queries/*.graphql'
generates:
  ./src/generated.ts:
    plugins:
      - typescript
      - typescript-operations
      - typescript-react-apollo
    config:
      withHooks: true
```

`.env` :

```
REACT_APP_PUBLIC_HOST=http://localhost:3000
REACT_APP_BRIGHTSPOT_HOST=http://localhost/cms
REACT_APP_GRAPHQL_URL=http://localhost/graphql/delivery/introspection-query-management
INTROSPECTION_KEY=correct-value
```

5. The front end application includes a script in the `package.json` file to run the GraphQL Code Generator with the command `yarn codegen`. This runs the introspection queries using the configuration defined above.

```json
"scripts": {
    "codegen": "graphql-codegen --require dotenv/config --config codegen.yml",
  }
```

The end result is a GraphQL API that is open to the public but with introspection queries available only to internal developers. This provides a layer of security by obscurity.

## Try it yourself

The following is a suggestion for learning more about GraphQL introspection with JS Classes and Brightspot:

1. Try changing the introspection query rule to support multiple keys.
2. Try making the introspection key configurable in Brightspot. Hint: You will need to add a `JavaField` to the endpoint and the introspection query rule.

## Troubleshooting

Refer to the [Common Issues](/README.md) section in the repository README for assistance.
