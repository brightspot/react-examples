# Introspection Query Management

GraphQL has an [introspection system](https://graphql.org/learn/introspection) that allows users to ask a schema for information about the queries it supports. GraphQL introspection queries can be useful for developers using code generation tools or for implementing build pipelines, but enabling them can expose sensitive information, so it is best practice to [disable them in production](https://www.apollographql.com/blog/graphql/security/why-you-should-disable-graphql-introspection-in-production/).

Brightspot makes it possible to create introspection query rules that allow or block introspection queries based on custom logic. This example demonstrates how to create an introspection query rule that only allows access if a specific HTTP header is passed, serving as a way to control who can make introspection queries.

## What you will learn

1. [Create an introspection query rule.](#1-create-an-introspection-query-rule)
2. [Apply the rule to an endpoint.](#2-apply-the-rule-to-an-endpoint)
3. [Configure the build pipeline to factor in the rule.](#3-configure-the-build-pipeline-to-factor-in-the-rule)

## Running the example application

> **_Note_** Just starting? Refer to the [README](/README.md) at the root of the `react-examples` repository for details on running example applications in depth.

### Install dependencies

Run the following command from the `introspection-query-management/app` directory:

```sh
$ yarn
```

```
[1/4] 🔍 Resolving packages...
[2/4] 🚚 Fetching packages...
[3/4] 🔗 Linking dependencies...
[4/4] 🔨 Building fresh packages...
✨ Done in 6.03s.
```

## Using the example application

The front end application uses types generated by the [GraphQL Code Generator](https://www.the-guild.dev/graphql/codegen) as part of the build pipeline. GraphQL Code Generator is set up to run introspection queries on the `Introspection Query Management` endpoint.

Those introspection queries fail if they do not include an `Introspection-Key` HTTP header with a value that matches the same field on the endpoint. To demonstrate this, run the following command from the `introspection-query-management/app` directory. An error message will appear saying the command failed.

```sh
$ yarn codegen
```

```
error Command failed with exit code 1.
```

Navigate through Brightspot to edit the endpoint at **☰** &rarr; **Admin** &rarr; **APIs** &rarr; **Endpoints** &rarr; **Introspection Query Management** and save any string value (ex. abcd1234) in the `Introspection Key` field. Then change the value of the `INTROSPECTION-KEY` environment variable in the `introspection-query-management/app/.env` file to match the value you used in Brightspot. Run the following command again and the GraphQL Code Generator will run the introspection queries and create the files, types, and hooks that the front end application needs in order to start.

```sh
$ yarn codegen
```

```
✔ Parse Configuration
❯ Generate outputs
  ❯ Generate ./src/generated.ts
✔ Parse Configuration
✔ Generate outputs
✨ Done in 7.17s.
```

You can run the front end application with the following command.

```sh
$ yarn start
```

```
Compiled successfully!
```

## How everything works

### 1. Create an introspection query rule

An introspection query rule is a class that implements the `IntrospectionQueryRule` abstract class and provides the body of the `isAllowed()` function. The `isAllowed()` function returns true or false based on whether a particular request should be allowed.

> **_Note_** By default, GraphQL Introspection is disabled in production mode.

```ts
[`isAllowed()`](): boolean {
  return true // allows all introspection queries
}
```

In this example, the [introspection query rule](./brightspot/src/brightspot/example/introspection_query_management/ExampleIntrospectionQueryRule.ts) only allows requests that contain a specific HTTP request header key and value.

### 2. Apply the rule to an endpoint

For an introspection query rule to take effect, it must be applied to an endpoint by overriding the endpoint's `getIntrospectionQueryRule()` function and returning a new instance of the introspection query rule class.

```ts
getIntrospectionQueryRule(): IntrospectionQueryRule {
  const ExampleIntrospectionQueryRule = ClassFinder.getClass(
    'brightspot.example.introspection_query_management.ExampleIntrospectionQueryRule'
  )

  return new ExampleIntrospectionQueryRule()
}
```

This example adds a field to the [endpoint](./brightspot/src/brightspot/example/introspection_query_management/IntrospectionQueryManagementEndpoint.ts) so that the key can be set through the Brightspot UI. The code passes the value of the key to the introspection query rule so that it can be checked against the request header.

### 3. Configure the build pipeline to factor in the rule

The specific configuration of a build pipeline that leverages introspection queries depends on the front end framework, build tools, and the business logic of the introspection rule. The pipeline in this example is one of many possible options.

This example uses GraphQL Code Generator to create types and hooks. It is configured with a `codegen.yml` file that defines the HTTP headers included in the requests it makes. It includes a script in the `package.json` file to run the code generator and the associated introspection queries.

[`codegen.yml`](./app/codegen.yml) :

```yml
schema:
  - ${REACT_APP_GRAPHQL_URL}:
      headers:
        Introspection-Key: ${INTROSPECTION_KEY}
```

[`.env`](./app/.env) :

```
REACT_APP_GRAPHQL_URL=http://localhost/graphql/delivery/introspection-query-management
INTROSPECTION_KEY=your-introspection-key-here
```

[`package.json`](./app/package.json) :

```json
"scripts": {
    "codegen": "graphql-codegen --require dotenv/config --config codegen.yml",
  }
```

The end result is a GraphQL API with introspection available to those that know the value of the configured introspection key.

## Try it yourself

The following is a suggestion for learning more about GraphQL introspection with JS Classes and Brightspot:

- Consider a case where each developer needs a separate introspection key. Try changing the endpoint and introspection query rule to support multiple keys.

## Troubleshooting

Refer to the [Common Issues](/README.md) section in the repository README for assistance.
